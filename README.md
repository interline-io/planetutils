[![current release version](https://img.shields.io/github/release/interline-io/planetutils.svg)](https://github.com/interline-io/planetutils/releases)
[![Docker Hub container image build status](https://img.shields.io/docker/build/interline/planetutils.svg)](https://hub.docker.com/r/interline/planetutils/)
[![CircleCI code test status](https://circleci.com/gh/interline-io/planetutils.svg?style=svg)](https://circleci.com/gh/interline-io/planetutils)

# Interline PlanetUtils

<!-- the following is generated by: npx markdown-toc -i README.md -->

<!-- toc -->

- [Features](#features)
- [Installation](#installation)
  * [Using Docker container](#using-docker-container)
  * [Using Homebrew on Mac OS](#using-homebrew-on-mac-os)
  * [Using Python package](#using-python-package)
- [Command-line Usage](#command-line-usage)
  * [osm_planet_update](#osm_planet_update)
  * [osm_planet_extract](#osm_planet_extract)
  * [osm_extract_download](#osm_extract_download)
  * [osm_planet_get_timestamp](#osm_planet_get_timestamp)
  * [elevation_tile_download](#elevation_tile_download)
  * [elevation_tile_merge](#elevation_tile_merge)
  * [valhalla_tilepack_list](#valhalla_tilepack_list)
  * [valhalla_tilepack_download](#valhalla_tilepack_download)
- [Specifying extract extents](#specifying-extract-extents)
  * [Bounding box file: CSV format](#bounding-box-file-csv-format)
  * [Bounding box/polygon file: GeoJSON format](#bounding-boxpolygon-file-geojson-format)
- [Switching toolchains](#switching-toolchains)
- [Support](#support)

<!-- tocstop -->

## Features

Python-based scripts and a Docker container to work with planet-scale geographic data. Using PlanetUtils, you can:

- maintain your own copy of the [OpenStreetMap](http://www.openstreetmap.org) planet (by applying incremental updates)
- cut your copy of the OSM planet into named bounding boxes
- download [OSM Extracts from Interline](https://www.interline.io/osm/extracts/) for popular cities and regions
- download [Mapzen Terrain Tiles from AWS](https://aws.amazon.com/public-datasets/terrain/) for the planet or your bounding boxes
- merge and resample Terrain Tiles
- download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks) for the planet (subscription required)

PlanetUtils is packaged for use as a:

- Docker container, for use on any operating system
- Python package, for use on any operating system
- Homebrew formula, for use on Mac OS

PlanetUtils is a "high level" library that makes use of [Osmosis](https://wiki.openstreetmap.org/wiki/Osmosis), [OSM C tools](https://gitlab.com/osm-c-tools/osmctools/), and [Osmium](https://osmcode.org/osmium-tool/) among other great open-source components.

## Installation

### Using Docker container

Make sure you have [Docker](https://www.docker.com/community-edition) installed. Then:

```sh
docker pull interline/planetutils:release-v0.4.10
```

Any of the example commands below can be executed with `docker run`. It may be helpful to mount a local directory inside the container for persistence and to access output files.

- Example of using `docker run` with the `data` directory mounted as `/data`:

```sh
docker run --rm -v ${PWD}/data:/data -t interline/planetutils:release-v0.4.10 <command>
```

### Using Homebrew on Mac OS

Make sure you have [Homebrew](https://brew.sh/) installed. Then:

```sh
brew install interline-io/planetutils/planetutils
```

### Using Python package

If you want to install and use the Python package directly, you'll need to provide:

- Python 2.x or 3.x
- Java and [Osmosis](https://wiki.openstreetmap.org/wiki/Osmosis)
- [OSM C tools](https://gitlab.com/osm-c-tools/osmctools/)
- [Osmium Tool](https://osmcode.org/osmium-tool/)
- [PyOsmium](https://osmcode.org/pyosmium/)
- [GDAL](https://www.gdal.org/) (both binaries and Python scripts)

Then clone this repo, run the tests, and install the Python package:

```sh
git clone https://github.com/interline-io/planetutils.git
python ./setup.py test
pip install .
```

## Command-line Usage

PlanetUtils supplies the following command-line utilities:

### osm_planet_update

Update a local OSM planet. For example:

```sh
osm_planet_update planet-recent.osm.pbf planet-with-updates.osm.pbf
```

If `planet-recent.osm.pbf` does not exist locally, the most recent planet file will be downloaded, before applying hourly updates to it. (Note: This download is nearly 40Gb.) By default, files are downloaded from planet.openstreetmap.org. Amazon Web Services also provides [OSM planets through its Public Datasets program](https://aws.amazon.com/public-datasets/osm/). To instead download the planet file from AWS:

1. Make sure you have your [AWS credentials configured locally](http://boto3.readthedocs.io/en/latest/guide/configuration.html).
2. Append the `--s3` flag.

Note that an entire OSM planet may be upwards of 40Gb in size! In other words, you should have ~80Gb free disk space before running this command.

For complete help on command-line arguments:

```sh
osm_planet_update -h
```

### osm_planet_extract

Cut up an OSM planet file into one or more extracts, defined by bounding boxes or polygons. Each extract is assigned a name. (This is like a mini version of Mapzen Metro Extracts!)

To create a single extract:

```sh
osm_planet_extract --outpath=data/osm_extracts --bbox=-122.737,37.449,-122.011,37.955 --name=san-francisco planet-latest.osm.pbf
```

To specify more than one bounding box of tiles to download, list the extents in a [CSV file or GeoJSON file](#bounding-box). For example:

```sh
osm_planet_extract --outpath=data/osm_extracts --csv=data/bboxes.csv planet-latest.osm.pbf
```

For complete help on command-line arguments:

```sh
osm_planet_extract -h
```

### osm_extract_download

Download regularly updated OSM extracts for popular cities and regions from [OSM Extracts by Interline](https://www.interline.io/osm/extracts). Browse available extracts using [the web interface]((https://www.interline.io/osm/extracts)) or [the GeoJSON file](https://github.com/interline-io/osm-extracts/blob/master/cities.geojson). Anyone can browse the available extracts or propose changes to the extract bounding boxes on [GitHub](https://github.com/interline-io/osm-extracts). A subscription is required to download extracts, to cover hosting costs and keep the service sustainable. (See the OSM Extracts website for more information on how profits are donated to OpenStreetMap and other "open" efforts.)

To download the latest copy of an extract (if `abcd` is your Interline API token and `abidjan_ivory-coast` is the ID for your chosen extract region):

```sh
osm_extract_download --api-token=abcd abidjan_ivory-coast
```

You can also download extracts in GeoJSON format by using `--data-format=geojson`. Warning: these can be very large files, but may be useful for filtering and displaying on a web map.

For complete help on command-line arguments:

```sh
osm_extract_download -h
```

(Note: OSM Extracts is a hosted and managed version of the PlanetUtils library. Every day, the pipeline runs the `osm_planet_update` and `osm_planet_extract` commands.)

### osm_planet_get_timestamp

A simple utility to print the timestamp of an OpenStreetMap PBF file.

```sh
osm_planet_get_timestamp planet-latest.osm.pbf
```

### elevation_tile_download

Download elevation tiles from the [Terrain Tiles in the AWS Public Datasets program](https://aws.amazon.com/public-datasets/terrain/). Download for the entire planet, only tiles within a single bounding box, or within multiple bounding boxes.

Elevation tiles are available in [a variety of formats](https://mapzen.com/documentation/terrain-tiles/formats/). This command supports the download of:
- GeoTIFF (default): extension `.tif` in Web Mercator projection, 512x512 tiles
- Skadi: extension `.hgt` in unprojected latlng, 1°x1° tiles

To download the entire planet in Skadi tiles (__which will require about 1.6Tb of space!__):

```sh
elevation_tile_download --format=skadi --outpath=data/elevation
```

To download GeoTIFF tiles to cover a single bounding box at a specified zoom level:

```sh
elevation_tile_download --outpath=data/elevation --bbox=-122.737,37.449,-122.011,37.955 --zoom=10
```

To specify more than one bounding box of tiles to download, list the bounding boxes in a [CSV file or GeoJSON file](#bounding-box). For example:

```sh
elevation_tile_download --outpath=data/elevation --csv=data/bboxes.csv
```

For complete help on command-line arguments:

```sh
elevation_tile_download -h
```

### elevation_tile_merge

After downloading elevation tiles using the `elevation_tile_download` command, use this command to merge together multiple tiles. You can optionally resample elevation values as part of the merge process.

This command only operates on GeoTIFF format elevation tiles.

Warnings: merging lots of tiles can be resource intensive!

To merge a directory of GeoTIFF files:

```sh
elevation_tile_merge single_tile.tif geo_tiff_tiles/
```

For complete help on command-line arguments:

```sh
elevation_tile_merge -h
```

### valhalla_tilepack_list

Use [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/) to power your own instances of the [Valhalla routing engine](https://www.interline.io/valhalla/). Anyone can list available planet tilepacks. A subscription and an API key are required to [download tilepacks](#valhalla_tilepack_download).

To list all available planet tilepacks:

```sh
valhalla_tilepack_list
```

For complete help on command-line arguments:

```sh
valhalla_tilepack_list -h
```

### valhalla_tilepack_download

Download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/) to power your own instances of the [Valhalla routing engine](https://www.interline.io/valhalla/). A subscription and an API key are required to download tilepacks.

Initial set-up:

1. Sign up for [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/).
2. Set your API token as an environment variable (`INTERLINE_API_TOKEN`) or use it as an argument to the command

To download the latest planet tilepack (if `abcd` is your Interline API token):

```sh
valhalla_tilepack_download --api-token=abcd
```

or set your API token as an environment variable, and download the latest planet tilepack:

```sh
export INTERLINE_API_TOKEN=abcd
valhalla_tilepack_download
```

For complete help on command-line arguments:

```sh
valhalla_tilepack_download -h
```

## Specifying extract extents
<a name="bounding-box"></a>

When extracting multiple bounding boxes or polygons from an OSM planet, or when downloading multiple bounding boxes of elevation tiles, you can specify your extents in a single file, either CSV or GeoJSON format.

### Bounding box file: CSV format

Do not include a header row. The format is as follows:

```csv
[name for extract],[left longitude],[bottom latitude],[right longitude],[top latitude]
```

For example:
```csv
san-francisco,-122.737,37.449,-122.011,37.955
dar-es-salaam,38.894,-7.120,39.661,-6.502
```

To determine a bounding box, try the tool at http://bboxfinder.com/

### Bounding box/polygon file: GeoJSON format

Alternatively, you can specify the bounding boxes or polygons as features in a GeoJSON file, using the `--geojson` argument.

```sh
osm_planet_extract --geojson=examples/test.geojson examples/san-francisco-downtown.osm.pbf
```

To draw extents in GeoJSON, try the tool at http://geojson.io/

## Switching toolchains

PlanetUtils wraps up a number of libraries, including Osmosis, Osmium, and OSM C Tools. Some PlanetUtils commands allow you to switch which library is used to perform the operation:

 | PlanetUtils command | argument flag | default | options |
 | ------------------- | ------------- | ------- | ------- |
 | `osm_planet_update` | `--toolchain` | `osmosis` | `osmosis`, `osmium` |
 | `osm_planet_extract` | `--toolchain` | `osmosis` | `osmosis`, `osmium`, `osmctools` |

If you are using `osm_planet_extract` with `--toolchain=osmium`, you can also use the `--strategy=` option to select `simple, complete_ways (default) or smart`.

If you are using `osm_planet_update` with `--toolchain=osmium`, you can also use the `--size=` option to limit the amount of updates downloaded from the OSM replication server. Osmium requires this data to be held in memory. The default is `1024` megabytes.

## Support

To report a bug, please [open an issue](https://github.com/interline-io/planetutils).

Interline Technologies also provides professional support and consulting services around this and other related tools. Contact us at info@interline.io for more information.
